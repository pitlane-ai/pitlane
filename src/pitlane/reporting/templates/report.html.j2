<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pitlane Report</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js" integrity="sha384-vsrfeLOOY6KuIYKDlmVH5UiBmgIdB1oEf7p01YgWHuqmOHfZr374+odEv96n9tNC" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chroma-js@2.4.2/chroma.min.js" integrity="sha384-VRhlkYEqoAXsWzoORIQL0gHdX0BvQoQG89GxEj7I4xlffttgMvoMsQr7E/IWGK9T" crossorigin="anonymous"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-size: 14px;
      line-height: 1.5;
      color: #1f2937;
      background: #f3f4f6;
    }

    /* Header */
    .header {
      background: #1a1a2e;
      color: #e5e7eb;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }
    .header h1 {
      font-size: 18px;
      font-weight: 600;
      color: #fff;
      flex: 1;
    }
    .header .run-dir {
      font-size: 12px;
      color: #9ca3af;
      font-family: monospace;
      word-break: break-all;
    }
    .header-badges {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* Metadata bar */
    .meta-bar {
      background: #f8f9fa;
      border-bottom: 1px solid #e5e7eb;
      padding: 8px 24px;
      display: flex;
      gap: 24px;
      flex-wrap: wrap;
      font-size: 12px;
      color: #6b7280;
    }
    .meta-item { display: flex; gap: 6px; align-items: center; }
    .meta-label { font-weight: 600; text-transform: uppercase; letter-spacing: .04em; }
    .meta-value { font-family: monospace; color: #374151; }

    /* Charts section */
    .charts-section {
      padding: 16px 24px 8px;
    }
    .chart-card {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,.1);
      overflow: hidden;
    }
    .chart-tabs {
      display: flex;
      border-bottom: 2px solid #e5e7eb;
    }
    .chart-tab-btn {
      padding: 8px 16px;
      border: none;
      background: none;
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      white-space: nowrap;
      transition: color .15s, border-color .15s;
    }
    .chart-tab-btn:hover { color: #374151; }
    .chart-tab-btn.active { color: #3b82f6; border-bottom-color: #3b82f6; }
    .chart-panel { display: none; padding: 16px; }
    .chart-panel.active { display: block; }
    .chart-controls {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .chart-controls label {
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: .04em;
    }
    .chart-controls select {
      font-size: 13px;
      padding: 4px 8px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      background: #f9fafb;
      color: #374151;
      cursor: pointer;
    }


    /* Summary cards */
    .summary {
      display: flex;
      gap: 16px;
      padding: 24px 24px 8px;
      flex-wrap: wrap;
    }
    .card {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,.1);
      padding: 16px 20px;
      min-width: 110px;
      text-align: center;
    }
    .card .card-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .05em;
      color: #6b7280;
    }
    .card .card-value {
      font-size: 28px;
      font-weight: 700;
      margin-top: 4px;
    }
    .card.configurations .card-value { color: #374151; }
    .card.avg-score .card-value { color: #3b82f6; }
    .card.errored .card-value { color: #f59e0b; }


    /* Chart containers */
    .chart-container {
      padding: 24px;
      max-width: 900px;
      margin: 0 auto;
    }
    .chart-container canvas {
      max-height: 350px;
    }
    .chart-fallback {
      padding: 24px;
      text-align: center;
      color: #6b7280;
      font-style: italic;
    }

    /* Suites container */
    .suites {
      padding: 8px 24px 32px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* Task sections */
    .task-section {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,.1);
      overflow: hidden;
    }
    .task-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 18px;
      background: #1e293b;
      color: #e5e7eb;
    }
    .task-name {
      font-weight: 700;
      font-size: 15px;
      flex: 1;
      color: #f1f5f9;
      word-break: break-word;
    }

    /* Agent list view */
    .agent-list-view {
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding: 12px 16px;
      background: #f1f5f9;
    }
    .agent-card {
      background: #fff;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
      overflow: hidden;
    }
    .agent-card details > summary { list-style: none; cursor: pointer; }
    .agent-card details > summary::-webkit-details-marker { display: none; }
    .agent-card details > summary::marker { display: none; }
    .agent-summary {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      background: #f8fafc;
      flex-wrap: wrap;
    }
    .agent-summary:hover { background: #f1f5f9; }
    .agent-name {
      font-weight: 600;
      font-size: 13px;
      flex: 1;
      word-break: break-word;
      color: #111827;
      min-width: 120px;
    }
    .suite-time {
      font-size: 12px;
      color: #6b7280;
      white-space: nowrap;
    }
    .agent-metric {
      font-family: monospace;
      font-size: 12px;
      color: #374151;
      background: #f3f4f6;
      padding: 2px 8px;
      border-radius: 4px;
      white-space: nowrap;
    }
    .metric-label {
      font-size: 10px;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: .04em;
      margin-right: 2px;
    }
    .agent-select {
      width: 16px;
      height: 16px;
      cursor: pointer;
      flex-shrink: 0;
    }
    .agent-detail {
      padding: 12px 14px;
      border-top: 1px solid #e5e7eb;
    }

    /* Task actions bar */
    .task-actions {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 10px 14px;
      background: #fff;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
    }
    .select-all-label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: #6b7280;
      cursor: pointer;
      user-select: none;
    }
    .compare-btn {
      margin-left: auto;
      padding: 6px 16px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: #3b82f6;
      color: #fff;
      transition: background .15s;
    }
    .compare-btn:hover:not(:disabled) { background: #2563eb; }
    .compare-btn:disabled {
      background: #e5e7eb;
      color: #9ca3af;
      cursor: not-allowed;
    }

    /* Compare view */
    .compare-view { background: #f1f5f9; padding: 12px 16px; }
    .compare-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    .back-btn {
      padding: 6px 14px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      background: #fff;
      font-size: 13px;
      font-weight: 600;
      color: #374151;
      cursor: pointer;
    }
    .back-btn:hover { background: #f9fafb; }
    .compare-grid {
      display: grid;
      gap: 12px;
      overflow-x: auto;
    }
    .compare-col {
      min-width: 320px;
      background: #fff;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
    }
    .compare-col-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      background: #f8fafc;
      border-bottom: 1px solid #e5e7eb;
      flex-wrap: wrap;
    }
    .compare-col-header .agent-name {
      font-weight: 600;
      font-size: 13px;
      flex: 1;
      word-break: break-word;
      color: #111827;
    }
    .compare-col-body { padding: 12px 14px; }
    .hidden { display: none; }

    /* Grouped metrics */
    .metrics-groups {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 10px 0;
    }
    .metrics-group {
      background: #f9fafb;
      border-radius: 6px;
      padding: 8px 12px;
      min-width: 140px;
      flex: 1;
    }
    .metrics-group-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .06em;
      color: #9ca3af;
      margin-bottom: 6px;
    }
    .prop-item {
      margin-bottom: 4px;
    }
    .prop-key {
      font-size: 11px;
      color: #6b7280;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .04em;
    }
    .prop-val {
      font-family: monospace;
      font-size: 13px;
      color: #111827;
      margin-top: 1px;
    }

    /* Repeat-stat props grid */
    .props-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding-top: 8px;
    }
    .props-grid .prop-item {
      background: #f9fafb;
      border-radius: 4px;
      padding: 5px 8px;
      min-width: 120px;
    }

    /* Cases */
    .cases-header {
      font-size: 12px;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: .05em;
      margin: 12px 0 8px;
    }

    .case-item {
      border-radius: 6px;
      margin-bottom: 4px;
      overflow: hidden;
    }

    .case-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 7px 10px;
      background: #f9fafb;
    }
    details.case-item .case-row {
      cursor: pointer;
    }

    .case-name {
      flex: 1;
      font-size: 13px;
      word-break: break-word;
    }

    .case-message {
      background: #fef2f2;
      border-left: 3px solid #ef4444;
      padding: 8px 12px;
      font-family: monospace;
      font-size: 12px;
      color: #7f1d1d;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* Badges */
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 9999px;
      font-size: 11px;
      font-weight: 700;
      white-space: nowrap;
    }
    .badge-pass    { background: #dcfce7; color: #166534; }
    .badge-fail    { background: #fee2e2; color: #991b1b; }
    .badge-error   { background: #fef3c7; color: #92400e; }
    .badge-skip    { background: #f3f4f6; color: #6b7280; }
    .badge-neutral { background: #e5e7eb; color: #374151; }
    .badge-role-assistant { background: #ede9fe; color: #5b21b6; }
    .badge-role-tool      { background: #dbeafe; color: #1e40af; }

    /* Score pill — color set inline via style attribute */
    .score-pill {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 9999px;
      font-size: 12px;
      font-weight: 700;
      font-family: monospace;
      white-space: nowrap;
    }

    /* Drill-down sections */
    .drill-section {
      margin-top: 12px;
    }
    .drill-section > summary {
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      color: #4b5563;
      padding: 6px 10px;
      background: #f3f4f6;
      border-radius: 6px;
      user-select: none;
      list-style: none;
    }
    .drill-section > summary::-webkit-details-marker { display: none; }
    .drill-section > summary::marker { display: none; }
    .drill-section > summary::before { content: "\25B6 "; font-size: 10px; color: #9ca3af; }
    .drill-section[open] > summary::before { content: "\25BC "; }

    /* Debug log */
    .debug-log-pre {
      margin-top: 8px;
      background: #0f172a;
      color: #e2e8f0;
      font-family: monospace;
      font-size: 11px;
      padding: 12px;
      border-radius: 6px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 400px;
      overflow-y: auto;
    }

    /* Conversation transcript */
    .transcript {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .transcript-empty {
      font-style: italic;
      color: #9ca3af;
      font-size: 12px;
      padding: 8px 0;
    }
    .msg-block {
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid #e5e7eb;
    }
    .msg-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      background: #f9fafb;
      font-size: 12px;
    }
    .msg-text {
      padding: 8px 12px;
      font-size: 13px;
      white-space: pre-wrap;
      word-break: break-word;
      color: #1f2937;
      background: #fff;
    }
    .tool-call-details {
      border: 1px solid #dbeafe;
      border-radius: 6px;
      overflow: hidden;
    }
    .tool-call-details > summary {
      cursor: pointer;
      padding: 6px 10px;
      background: #eff6ff;
      font-size: 12px;
      font-weight: 600;
      color: #1e40af;
      user-select: none;
      list-style: none;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .tool-call-details > summary::-webkit-details-marker { display: none; }
    .tool-call-details > summary::marker { display: none; }
    .tool-call-details > summary::before { content: "\25B6 "; font-size: 10px; color: #93c5fd; }
    .tool-call-details[open] > summary::before { content: "\25BC "; }
    .tool-input-pre {
      padding: 8px 12px;
      font-family: monospace;
      font-size: 11px;
      background: #fff;
      color: #1e3a8a;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 300px;
      overflow-y: auto;
    }

    /* Workspace explorer */
    .workspace-tree {
      margin-top: 8px;
      font-size: 12px;
    }
    details.dir-item > summary {
      cursor: pointer;
      padding: 4px 8px;
      color: #374151;
      font-weight: 600;
      user-select: none;
      list-style: none;
    }
    details.dir-item > summary::-webkit-details-marker { display: none; }
    details.dir-item > summary::marker { display: none; }
    details.dir-item > summary::before { content: "\1F4C1 "; }
    details.dir-item[open] > summary::before { content: "\1F4C2 "; }
    .dir-children { padding-left: 16px; border-left: 1px solid #e5e7eb; margin-left: 8px; }
    details.file-item > summary {
      cursor: pointer;
      padding: 3px 8px;
      color: #4b5563;
      user-select: none;
      list-style: none;
    }
    details.file-item > summary::-webkit-details-marker { display: none; }
    details.file-item > summary::marker { display: none; }
    details.file-item > summary::before { content: "\1F4C4 "; }
    .file-content {
      font-family: monospace;
      font-size: 11px;
      background: #f8fafc;
      color: #1e293b;
      padding: 8px 12px;
      border-radius: 4px;
      margin: 4px 8px;
      white-space: pre;
      overflow-x: auto;
      max-height: 400px;
      overflow-y: auto;
    }
  </style>
</head>
<body>

{# ── Workspace tree macro ─────────────────────────────────────────────────── #}
{% macro render_tree(node) %}
{% for name, value in node.items() | sort %}
  {% if value is mapping and value.get('_file') %}
  <details class="file-item"><summary class="file-name">{{ name }}</summary>
    <pre class="file-content">{{ value.content }}</pre>
  </details>
  {% elif value is mapping %}
  <details class="dir-item"><summary class="dir-name">{{ name }}/</summary>
    <div class="dir-children">{{ render_tree(value) }}</div>
  </details>
  {% endif %}
{% endfor %}
{% endmacro %}

{# ── Score pill macro: color applied client-side via chroma.js ─────────── #}
{% macro score_pill(score) %}
{% if score is not none %}
  {% set score_value = score|float %}
  <span class="score-pill" data-score="{{ score_value }}">{{ score_value }}</span>
{% endif %}
{% endmacro %}

<header class="header">
  <div style="flex:1">
    <h1>Pitlane Report</h1>
    <div class="run-dir">{{ run_dir }}</div>
  </div>
  <div class="header-badges">
    <span class="badge badge-neutral">{{ total_configurations }} configurations</span>
    {% if total_errors > 0 %}
    <span class="badge badge-error">{{ total_errors }} errors</span>
    {% endif %}
  </div>
</header>

{% if meta %}
<div class="meta-bar">
  {% if meta.timestamp %}
  <div class="meta-item">
    <span class="meta-label">Run</span>
    <span class="meta-value">{{ meta.timestamp }}</span>
  </div>
  {% endif %}
  {% if meta.pitlane_version %}
  <div class="meta-item">
    <span class="meta-label">Pitlane</span>
    <span class="meta-value">{{ meta.pitlane_version }}</span>
  </div>
  {% endif %}
  {% if meta.cli_versions %}
  <div class="meta-item">
    <span class="meta-label">CLIs</span>
    <span class="meta-value">
      {% for cli, ver in meta.cli_versions.items() %}{{ cli }}={{ ver }}{% if not loop.last %}, {% endif %}{% endfor %}
    </span>
  </div>
  {% endif %}
  {% if meta.repeat and meta.repeat > 1 %}
  <div class="meta-item">
    <span class="meta-label">Repeat</span>
    <span class="meta-value">{{ meta.repeat }}&times;</span>
  </div>
  {% endif %}
</div>
{% endif %}

{# ══════════════════════════════════════════════════════════════════════════ #}
{# ── Summary cards + table ────────────────────────────────────────────────── #}
{# ══════════════════════════════════════════════════════════════════════════ #}

<section class="summary">
  <div class="card configurations">
    <div class="card-label">Configurations</div>
    <div class="card-value">{{ total_configurations }}</div>
  </div>
  <div class="card avg-score">
    <div class="card-label">Avg Score</div>
    <div class="card-value">{{ avg_score if avg_score is not none else '-' }}</div>
  </div>
  <div class="card errored">
    <div class="card-label">Errors</div>
    <div class="card-value">{{ total_errors }}</div>
  </div>
</section>

{# ══════════════════════════════════════════════════════════════════════════ #}
{# ── Charts ──────────────────────────────────────────────────────────────── #}
{# ══════════════════════════════════════════════════════════════════════════ #}
<div class="charts-section">
  <div class="chart-card">
    <div class="chart-tabs">
      <button class="chart-tab-btn active" onclick="switchChart(event,'chart-panel-overview')">Cost vs Time</button>
      <button class="chart-tab-btn" onclick="switchChart(event,'chart-panel-explore')">Explore</button>
    </div>
    <div id="chart-panel-overview" class="chart-panel active">
      <div class="chart-container">
        <canvas id="chart-cost-time"></canvas>
        <div class="chart-fallback hidden" id="fallback-cost-time">Chart.js could not be loaded.</div>
      </div>
    </div>
    <div id="chart-panel-explore" class="chart-panel">
      <div class="chart-controls">
        <label for="explore-x">X axis</label>
        <select id="explore-x" onchange="renderExploreChart()"></select>
        <label for="explore-y">Y axis</label>
        <select id="explore-y" onchange="renderExploreChart()"></select>
      </div>
      <div class="chart-container">
        <canvas id="chart-explore"></canvas>
        <div class="chart-fallback hidden" id="fallback-explore">Chart.js could not be loaded.</div>
      </div>
    </div>
  </div>
</div>

{# ══════════════════════════════════════════════════════════════════════════ #}
{# ── Configuration Results ───────────────────────────────────────────────── #}
{# ══════════════════════════════════════════════════════════════════════════ #}
<section class="suites" id="detailed-data">
  {% for task_name, agents in tasks %}
  {% set ns_task = namespace(score_sum=0, score_count=0) %}
  {% for suite in agents %}
    {% if suite.properties.get('weighted_score') is not none %}
      {% set ns_task.score_sum = ns_task.score_sum + suite.properties.weighted_score|float %}
      {% set ns_task.score_count = ns_task.score_count + 1 %}
    {% endif %}
  {% endfor %}
  {% set task_avg = (ns_task.score_sum / ns_task.score_count)|round(1) if ns_task.score_count > 0 else none %}
  <div class="task-section">
    <div class="task-header">
      <span class="task-name">{{ task_name }}</span>
      {% if task_avg is not none %}
      <span class="agent-metric">Avg: {{ task_avg }}</span>
      {{ score_pill(task_avg) }}
      {% endif %}
    </div>

    <div class="agent-list-view">
      {% for suite in agents %}
      {% set props = suite.properties %}
      {% set score_val = props.get('weighted_score') %}
      <div class="agent-card" data-agent-idx="{{ loop.index0 }}">
        <details {% if agents | length == 1 %}open{% endif %}>
          <summary class="agent-summary">
            <input type="checkbox" class="agent-select"
                   onclick="event.stopPropagation(); updateCompareBtn(this)">
            <span class="agent-name">{{ suite.assistant_name }}</span>
            {{ score_pill(score_val) }}
            {% if props.get('weighted_score_stddev') is not none %}<span style="color:#9ca3af; font-size:11px;">&plusmn;{{ props.weighted_score_stddev }}</span>{% endif %}
            <span class="agent-metric"><span class="metric-label">cost</span> ${{ props.cost_usd if props.get('cost_usd') is not none else '-' }}</span>
            {% if suite.time %}
            <span class="agent-metric"><span class="metric-label">time</span> {{ "%.2f"|format(suite.time) }}s</span>
            {% endif %}
            <span class="agent-metric">
              {% set passed = suite.tests - suite.failures - suite.errors %}
              <span class="metric-label">assertions</span> {{ passed }}/{{ suite.tests }}
            </span>
            {% if props.get('timed_out') and props.timed_out|float > 0 %}
            <span class="badge badge-error">TIMEOUT</span>
            {% endif %}
          </summary>

          <div class="agent-detail">

            {# ── Grouped metrics ──────────────────────────────────────── #}
            {% if props %}
            {% set score_keys = ['weighted_score', 'assertion_pass_rate'] %}
            {% set cost_keys  = ['cost_usd', 'token_usage_input', 'token_usage_output'] %}
            {% set perf_keys  = ['wall_clock_seconds', 'tool_calls_count'] %}
            {% set file_keys  = ['files_created', 'files_modified', 'total_lines_generated'] %}

            {# Collect repeat-stat keys (end in _avg/_stddev/_min/_max) #}
            {% set ns = namespace(repeat_items=[]) %}
            {% for k, v in props.items() %}
              {% if k.endswith('_avg') or k.endswith('_stddev') or k.endswith('_min') or k.endswith('_max') %}
                {% set ns.repeat_items = ns.repeat_items + [(k, v)] %}
              {% endif %}
            {% endfor %}

            <div class="metrics-groups">
              {# Scores #}
              {% set score_items = [] %}
              {% for k in score_keys %}{% if props.get(k) is not none %}{% set _ = score_items.append((k, props[k])) %}{% endif %}{% endfor %}
              {% if score_items %}
              <div class="metrics-group">
                <div class="metrics-group-label">Scores</div>
                {% for k, v in score_items %}
                <div class="prop-item">
                  <div class="prop-key">{{ k }}</div>
                  <div class="prop-val">{{ v }}</div>
                </div>
                {% endfor %}
              </div>
              {% endif %}

              {# Cost & Tokens #}
              {% set cost_items = [] %}
              {% for k in cost_keys %}{% if props.get(k) is not none %}{% set _ = cost_items.append((k, props[k])) %}{% endif %}{% endfor %}
              {% if cost_items %}
              <div class="metrics-group">
                <div class="metrics-group-label">Cost &amp; Tokens</div>
                {% for k, v in cost_items %}
                <div class="prop-item">
                  <div class="prop-key">{{ k }}</div>
                  <div class="prop-val">{{ v }}</div>
                </div>
                {% endfor %}
              </div>
              {% endif %}

              {# Performance #}
              {% set perf_items = [] %}
              {% for k in perf_keys %}{% if props.get(k) is not none %}{% set _ = perf_items.append((k, props[k])) %}{% endif %}{% endfor %}
              {% if perf_items %}
              <div class="metrics-group">
                <div class="metrics-group-label">Performance</div>
                {% for k, v in perf_items %}
                <div class="prop-item">
                  <div class="prop-key">{{ k }}</div>
                  <div class="prop-val">{{ v }}</div>
                </div>
                {% endfor %}
              </div>
              {% endif %}

              {# Files #}
              {% set file_items = [] %}
              {% for k in file_keys %}{% if props.get(k) is not none %}{% set _ = file_items.append((k, props[k])) %}{% endif %}{% endfor %}
              {% if file_items %}
              <div class="metrics-group">
                <div class="metrics-group-label">Files</div>
                {% for k, v in file_items %}
                <div class="prop-item">
                  <div class="prop-key">{{ k }}</div>
                  <div class="prop-val">{{ v }}</div>
                </div>
                {% endfor %}
              </div>
              {% endif %}
            </div>

            {# Repeat stats — collapsed details #}
            {% if ns.repeat_items %}
            <details class="drill-section">
              <summary>Consistency metrics — avg/stddev/min/max across {{ meta.repeat }} runs</summary>
              <div class="props-grid">
                {% for k, v in ns.repeat_items | sort %}
                <div class="prop-item">
                  <div class="prop-key">{{ k }}</div>
                  <div class="prop-val">{{ v }}</div>
                </div>
                {% endfor %}
              </div>
            </details>
            {% endif %}

            {% endif %}

            {# ── Test cases ───────────────────────────────────────────── #}
            {% if suite.cases %}
            <div class="cases-header">Test Cases</div>
            {% for case in suite.cases %}
            {% if case.result %}
            <details class="case-item">
              <summary class="case-row">
                {% if case.result.status == "Failure" %}
                <span class="badge badge-fail">FAIL</span>
                {% elif case.result.status == "Error" %}
                <span class="badge badge-error">ERROR</span>
                {% else %}
                <span class="badge badge-skip">SKIP</span>
                {% endif %}
                <span class="case-name">{{ case.name }}</span>
              </summary>
              {% if case.result.message %}
              <div class="case-message">{{ case.result.message }}</div>
              {% endif %}
            </details>
            {% else %}
            <div class="case-item">
              <div class="case-row">
                <span class="badge badge-pass">PASS</span>
                <span class="case-name">{{ case.name }}</span>
              </div>
            </div>
            {% endif %}
            {% endfor %}
            {% endif %}

            {# ── Debug log ──────────────────────────────────────────── #}
            {% if suite.debug_log %}
            <details class="drill-section" {% if suite.errors > 0 %}open{% endif %}>
              <summary>Debug log</summary>
              <pre class="debug-log-pre">{{ suite.debug_log }}</pre>
            </details>
            {% endif %}

            {# ── Conversation transcript ─────────────────────────────── #}
            <details class="drill-section">
              <summary>Agent transcript ({{ suite.conversation | length }} messages)</summary>
              <div class="transcript">
                {% if not suite.conversation %}
                <div class="transcript-empty">No conversation recorded — adapter may have failed to start</div>
                {% else %}
                {% for msg in suite.conversation %}
                {% if msg.get('tool_use') %}
                <details class="tool-call-details">
                  <summary>
                    <span class="badge badge-role-tool">TOOL</span>
                    {{ msg.tool_use.name }}
                  </summary>
                  <pre class="tool-input-pre">{{ msg.tool_use.input | tojson(indent=2) }}</pre>
                </details>
                {% elif msg.get('content') %}
                <div class="msg-block">
                  <div class="msg-header">
                    <span class="badge badge-role-assistant">{{ msg.role | upper }}</span>
                  </div>
                  <div class="msg-text">{{ msg.content }}</div>
                </div>
                {% endif %}
                {% endfor %}
                {% endif %}
              </div>
            </details>

            {# ── Workspace file explorer ────────────────────────────── #}
            {% if suite.workspace_files %}
            <details class="drill-section">
              <summary>Workspace ({{ suite.workspace_files | length }} files)</summary>
              <div class="workspace-tree">
                {{ render_tree(suite.workspace_tree) }}
              </div>
            </details>
            {% endif %}

          </div>{# agent-detail #}
        </details>
      </div>{# agent-card #}
      {% endfor %}

      <div class="task-actions">
        <label class="select-all-label">
          <input type="checkbox" class="select-all"
                 onchange="toggleSelectAll(this)"> Select all
        </label>
        <button class="compare-btn" disabled
                onclick="openCompare(this)">Compare (0 selected)</button>
      </div>
    </div>{# agent-list-view #}

    {# ── Compare view (hidden) ─────────────────────────────────────── #}
    <div class="compare-view hidden">
      <div class="compare-bar">
        <button class="back-btn" onclick="closeCompare(this)">&larr; Back to list</button>
      </div>
      <div class="compare-grid"></div>
    </div>
  </div>{# task-section #}
  {% endfor %}
</section>

<script>
/* ── Chart data ──────────────────────────────────────────────────────────── */
var chartData = {{ chart_data_json|safe }};

/* ── Chart tab switching ─────────────────────────────────────────────────── */
function switchChart(event, panelId) {
  var btns = document.querySelectorAll('.chart-tab-btn');
  for (var i = 0; i < btns.length; i++) btns[i].classList.remove('active');
  event.currentTarget.classList.add('active');
  var panels = document.querySelectorAll('.chart-panel');
  for (var i = 0; i < panels.length; i++) panels[i].classList.remove('active');
  document.getElementById(panelId).classList.add('active');
}

/* ── Compare functions ────────────────────────────────────────────────────── */
function updateCompareBtn(checkbox) {
  var section = checkbox.closest('.task-section');
  var checks = section.querySelectorAll('.agent-select:checked');
  var btn = section.querySelector('.compare-btn');
  var n = checks.length;
  btn.textContent = 'Compare (' + n + ' selected)';
  btn.disabled = n < 2;
  var allChecks = section.querySelectorAll('.agent-select');
  var selectAll = section.querySelector('.select-all');
  if (selectAll) selectAll.checked = checks.length === allChecks.length;
}

function toggleSelectAll(checkbox) {
  var section = checkbox.closest('.task-section');
  var checks = section.querySelectorAll('.agent-select');
  for (var i = 0; i < checks.length; i++) checks[i].checked = checkbox.checked;
  var btn = section.querySelector('.compare-btn');
  var n = checkbox.checked ? checks.length : 0;
  btn.textContent = 'Compare (' + n + ' selected)';
  btn.disabled = n < 2;
}

function openCompare(button) {
  var section = button.closest('.task-section');
  var listView = section.querySelector('.agent-list-view');
  var compareView = section.querySelector('.compare-view');
  var grid = compareView.querySelector('.compare-grid');
  grid.innerHTML = '';

  var cards = section.querySelectorAll('.agent-card');
  var n = 0;
  for (var i = 0; i < cards.length; i++) {
    var cb = cards[i].querySelector('.agent-select');
    if (!cb || !cb.checked) continue;
    n++;
    var col = document.createElement('div');
    col.className = 'compare-col';
    var header = document.createElement('div');
    header.className = 'compare-col-header';
    var summary = cards[i].querySelector('.agent-summary');
    var children = summary.children;
    for (var j = 0; j < children.length; j++) {
      if (children[j].classList.contains('agent-select')) continue;
      header.appendChild(children[j].cloneNode(true));
    }
    col.appendChild(header);
    var detail = cards[i].querySelector('.agent-detail');
    if (detail) {
      var body = document.createElement('div');
      body.className = 'compare-col-body';
      body.innerHTML = detail.innerHTML;
      col.appendChild(body);
    }
    grid.appendChild(col);
  }

  grid.style.gridTemplateColumns = 'repeat(' + n + ', minmax(320px, 1fr))';
  listView.classList.add('hidden');
  compareView.classList.remove('hidden');
}

function closeCompare(button) {
  var section = button.closest('.task-section');
  var listView = section.querySelector('.agent-list-view');
  var compareView = section.querySelector('.compare-view');
  compareView.classList.add('hidden');
  compareView.querySelector('.compare-grid').innerHTML = '';
  listView.classList.remove('hidden');
}


/* ── Score color helper (red→amber→green, gamma=2 power curve) ──────────── */
var scoreScale = chroma.scale(['#ef4444', '#ef9e0b', '#22c55e']).domain([0, 50, 100]).gamma(2);

function scoreColor(score) {
  return scoreScale(score).css();
}

document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.score-pill[data-score]').forEach(function(el) {
    var score = parseFloat(el.getAttribute('data-score'));
    if (isNaN(score)) return;
    el.style.color = scoreScale(score).css();
    el.style.background = scoreScale(score).alpha(0.25).css();
  });
});

/* ── Charts ──────────────────────────────────────────────────────────────── */
/* Metric display names */
var metricLabels = {
  cost: 'Cost (USD)',
  latency: 'Time (seconds)',
  score: 'Score',
  tool_calls_count: 'Tool Calls',
  token_usage_input: 'Input Tokens',
  token_usage_output: 'Output Tokens',
  total_tokens: 'Total Tokens',
  files_created: 'Files Created',
  files_modified: 'Files Modified',
  total_lines_generated: 'Lines Generated',
  assertion_pass_rate: 'Assertion Pass Rate (%)'
};

var exploreChart = null;

(function() {
  if (typeof Chart === 'undefined') {
    var fallbacks = document.querySelectorAll('.chart-fallback');
    for (var i = 0; i < fallbacks.length; i++) fallbacks[i].classList.remove('hidden');
    var canvases = document.querySelectorAll('.chart-container canvas');
    for (var i = 0; i < canvases.length; i++) canvases[i].style.display = 'none';
    return;
  }

  /* Cost vs Time scatter (dot color = score) */
  var costTimeData = chartData.filter(function(d) { return d.cost !== null && d.latency !== null; });
  if (costTimeData.length > 0) {
    var points = [];
    var colors = [];
    for (var i = 0; i < costTimeData.length; i++) {
      var d = costTimeData[i];
      points.push({x: d.latency, y: d.cost, label: d.assistant, score: d.score});
      colors.push(scoreColor(d.score));
    }
    new Chart(document.getElementById('chart-cost-time'), {
      type: 'scatter',
      data: {datasets: [{
        data: points,
        backgroundColor: colors,
        borderColor: colors,
        pointRadius: 8,
        pointHoverRadius: 10
      }]},
      options: {
        responsive: true,
        plugins: {
          title: {display: true, text: 'Time vs Cost (color = score)'},
          legend: {display: false},
          tooltip: {callbacks: {label: function(ctx) {
            var p = ctx.raw;
            return p.label + ': ' + p.x.toFixed(1) + 's, $' + p.y.toFixed(4) + ', Score ' + p.score;
          }}}
        },
        scales: {
          x: {title: {display: true, text: 'Time (seconds)'}},
          y: {title: {display: true, text: 'Cost (USD)'}}
        }
      }
    });
  }

  /* Populate explore axis dropdowns with metrics that have data */
  var metricKeys = Object.keys(metricLabels);
  var available = metricKeys.filter(function(k) {
    return chartData.some(function(d) { return d[k] !== null && d[k] !== undefined; });
  });

  var xSel = document.getElementById('explore-x');
  var ySel = document.getElementById('explore-y');
  available.forEach(function(k) {
    var ox = document.createElement('option');
    ox.value = k; ox.textContent = metricLabels[k];
    xSel.appendChild(ox);
    var oy = document.createElement('option');
    oy.value = k; oy.textContent = metricLabels[k];
    ySel.appendChild(oy);
  });

  /* Default X=cost, Y=tool_calls_count (or first two available) */
  var defX = available.indexOf('cost') >= 0 ? 'cost' : available[0];
  var defY = available.indexOf('tool_calls_count') >= 0 ? 'tool_calls_count'
           : available.indexOf('latency') >= 0 ? 'latency'
           : available[1] || available[0];
  xSel.value = defX;
  ySel.value = defY;
  renderExploreChart();
})();

function renderExploreChart() {
  var xKey = document.getElementById('explore-x').value;
  var yKey = document.getElementById('explore-y').value;
  var data = chartData.filter(function(d) {
    return d[xKey] !== null && d[xKey] !== undefined &&
           d[yKey] !== null && d[yKey] !== undefined;
  });

  var points = [];
  var colors = [];
  for (var i = 0; i < data.length; i++) {
    var d = data[i];
    points.push({x: d[xKey], y: d[yKey], label: d.assistant, score: d.score});
    colors.push(scoreColor(d.score));
  }

  var xLabel = metricLabels[xKey] || xKey;
  var yLabel = metricLabels[yKey] || yKey;

  if (exploreChart) { exploreChart.destroy(); }
  exploreChart = new Chart(document.getElementById('chart-explore'), {
    type: 'scatter',
    data: {datasets: [{
      data: points,
      backgroundColor: colors,
      borderColor: colors,
      pointRadius: 8,
      pointHoverRadius: 10
    }]},
    options: {
      responsive: true,
      plugins: {
        title: {display: true, text: xLabel + ' vs ' + yLabel + ' (color = score)'},
        legend: {display: false},
        tooltip: {callbacks: {label: function(ctx) {
          var p = ctx.raw;
          return p.label + ': ' + p.x + ', ' + p.y + ', Score ' + p.score;
        }}}
      },
      scales: {
        x: {title: {display: true, text: xLabel}},
        y: {title: {display: true, text: yLabel}}
      }
    }
  });
}
</script>
</body>
</html>
