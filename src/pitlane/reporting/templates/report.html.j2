<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>pitlane Report</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f5f5f5; color: #333; padding: 24px; }
  h1 { font-size: 24px; margin-bottom: 8px; }
  h2 { font-size: 20px; margin: 24px 0 12px; }
  h3 { font-size: 16px; margin: 12px 0 8px; }
  .meta { color: #666; font-size: 14px; margin-bottom: 24px; }
  .debug-link { display: inline-block; margin-bottom: 16px; padding: 8px 12px; background: #f0f0f0; border-radius: 4px; text-decoration: none; color: #333; font-size: 13px; }
  .debug-link:hover { background: #e0e0e0; }
  table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px; }
  th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid #eee; font-size: 14px; }
  th { background: #fafafa; font-weight: 600; }
  .pass { background: #e6f9e6; color: #1a7a1a; }
  .partial { background: #fff8e6; color: #8a6d00; }
  .fail { background: #fde6e6; color: #a00; }
  .metric { font-size: 12px; color: #666; }
  .details { display: none; background: #fafafa; padding: 16px; }
  .details.open { display: block; }
  .toggle { cursor: pointer; user-select: none; }
  .toggle:hover { background: #f0f0f0; }
  .assertion-list { list-style: none; padding: 0; }
  .assertion-list li { padding: 4px 0; font-size: 13px; }
  .assertion-list li::before { content: "âœ“ "; color: #1a7a1a; }
  .assertion-list li.failed::before { content: "âœ— "; color: #a00; }
  .chart-section { margin-bottom: 24px; }
  .chart-row { display: flex; align-items: center; gap: 8px; margin: 4px 0; font-size: 13px; }
  .chart-label { width: 140px; text-align: right; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .chart-bar { height: 20px; border-radius: 3px; transition: width 0.3s; }
  .colors { --c0: #4285f4; --c1: #ea4335; --c2: #fbbc04; --c3: #34a853; --c4: #ff6d01; --c5: #46bdc6; }
  .repeat-badge { display: inline-block; padding: 2px 8px; background: #e3f2fd; color: #1565c0; border-radius: 10px; font-size: 12px; font-weight: 600; margin-left: 8px; }
  .stats-table { font-size: 12px; }
  .stats-table td, .stats-table th { padding: 4px 10px; }
  .iter-details { display: none; background: #f9f9f9; padding: 12px; margin-top: 8px; border-radius: 4px; }
  .iter-details.open { display: block; }
  .iter-toggle { cursor: pointer; color: #1565c0; font-size: 12px; text-decoration: underline; }
</style>
</head>
<body class="colors">
<h1>pitlane Report{% if repeat > 1 %}<span class="repeat-badge">{{ repeat }}x repeat</span>{% endif %}</h1>
<p class="meta">Generated from run data{% if repeat > 1 %} â€” each task repeated {{ repeat }} times, showing averages Â± stddev{% endif %}</p>
<a href="debug.log" class="debug-link">ðŸ“‹ View main debug.log</a>
{% for assistant in assistants %}
  {% for task in tasks %}
    {% if results[assistant][task] %}
      <a href="{{ assistant }}/{{ task }}/debug.log" class="debug-link">ðŸ“‹ {{ assistant }}/{{ task }} debug.log</a>
    {% endif %}
  {% endfor %}
{% endfor %}

<h2>Summary</h2>
<table>
  <thead>
    <tr>
      <th>Task</th>
      {% for assistant in assistants %}
      <th>{{ assistant }}</th>
      {% endfor %}
    </tr>
  </thead>
  <tbody>
    {% for task in tasks %}
    <tr class="toggle" onclick="toggleDetails('{{ task }}')">
      <td><strong>{{ task }}</strong></td>
      {% for assistant in assistants %}
      {% set r = results[assistant][task] %}
      {% if r %}
      {% if r.all_passed %}
      <td class="pass">
      {% elif r.metrics.assertion_pass_rate > 0 %}
      <td class="partial">
      {% else %}
      <td class="fail">
      {% endif %}
        {% if repeat > 1 and r.repeat %}
        {{ r.repeat.all_passed_rate }}% runs pass<br>
        <span class="metric">avg {{ "%.1f"|format(r.metrics.wall_clock_seconds) }}s | {% if r.metrics.tool_calls_count is not none %}{{ "%.0f"|format(r.metrics.tool_calls_count) }}{% else %}?{% endif %} tools{% if r.metrics.cost_usd %} | ${{ "%.4f"|format(r.metrics.cost_usd) }}{% endif %}</span>
        {% else %}
        {{ r.metrics.assertion_pass_rate }}% pass | {{ r.metrics.weighted_score }}% weighted<br>
        <span class="metric">{{ "%.1f"|format(r.metrics.wall_clock_seconds) }}s | {% if r.metrics.tool_calls_count is not none %}{{ r.metrics.tool_calls_count }}{% else %}unknown{% endif %} tools{% if r.metrics.cost_usd %} | ${{ "%.4f"|format(r.metrics.cost_usd) }}{% endif %}</span>
        {% endif %}
      </td>
      {% else %}
      <td>â€”</td>
      {% endif %}
      {% endfor %}
    </tr>
    <tr>
      <td colspan="{{ assistants|length + 1 }}">
        <div class="details" id="details-{{ task }}">
          {% if repeat > 1 %}
          {# --- Repeat mode: show stats table --- #}
          <h4 style="margin: 0 0 8px;">Metrics (avg Â± stddev across {{ repeat }} runs)</h4>
          <table class="stats-table">
            <thead>
              <tr>
                <th>Metric</th>
                {% for assistant in assistants %}
                <th>{{ assistant }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for metric_key in metric_keys %}
              <tr>
                <td>{{ metric_key }}</td>
                {% for assistant in assistants %}
                {% set r = results[assistant][task] %}
                <td>
                  {% if r and r.metrics_stats and r.metrics_stats[metric_key] %}
                  {% set s = r.metrics_stats[metric_key] %}
                  {% if s.avg is not none %}
                    {% if metric_key == "wall_clock_seconds" %}{{ "%.1f"|format(s.avg) }} Â± {{ "%.1f"|format(s.stddev) }}{% elif metric_key == "cost_usd" %}{{ "%.4f"|format(s.avg) }} Â± {{ "%.4f"|format(s.stddev) }}{% else %}{{ s.avg }} Â± {{ s.stddev }}{% endif %}
                    <br><span class="metric">min={{ s.min }} max={{ s.max }}</span>
                  {% else %}â€”{% endif %}
                  {% elif r and r.metrics[metric_key] is not none %}
                    {% if metric_key == "wall_clock_seconds" %}{{ "%.1f"|format(r.metrics[metric_key]) }}{% elif metric_key == "cost_usd" %}{{ "%.4f"|format(r.metrics[metric_key]) }}{% else %}{{ r.metrics[metric_key] }}{% endif %}
                  {% else %}â€”{% endif %}
                </td>
                {% endfor %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% else %}
          {# --- Single run mode --- #}
          <table>
            <thead>
              <tr>
                <th>Metric</th>
                {% for assistant in assistants %}
                <th>{{ assistant }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for metric_key in metric_keys %}
              <tr>
                <td>{{ metric_key }}</td>
                {% for assistant in assistants %}
                {% set r = results[assistant][task] %}
                <td>{% if r %}{% if r.metrics[metric_key] is not none %}{% if metric_key == "wall_clock_seconds" %}{{ "%.1f"|format(r.metrics[metric_key]) }}{% elif metric_key == "cost_usd" %}{{ "%.4f"|format(r.metrics[metric_key]) }}{% else %}{{ r.metrics[metric_key] }}{% endif %}{% else %}â€”{% endif %}{% else %}â€”{% endif %}</td>
                {% endfor %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% endif %}

          <h4 style="margin: 12px 0 8px;">Assertions{% if repeat > 1 %} (pass rate across iterations){% endif %}</h4>
          {% for assistant in assistants %}
          <p><strong>{{ assistant }}</strong></p>
          {% set r = results[assistant][task] %}
          {% if r %}
          <ul class="assertion-list">
            {% for a in r.assertions %}
            <li{% if not a.passed %} class="failed"{% endif %}>{{ a.name }}{% if a.message %} â€” {{ a.message }}{% endif %}{% if repeat > 1 and a.pass_rate is defined %} ({{ a.pass_rate }}%){% endif %}{% if a.weight is defined and a.weight != 1.0 %} [weight={{ a.weight }}]{% endif %}{% if a.score is defined %} [score={{ "%.4f"|format(a.score) }}]{% endif %}</li>
            {% endfor %}
          </ul>
          {% if repeat > 1 and r.repeat %}
          <span class="iter-toggle" onclick="toggleIterDetails('{{ assistant }}-{{ task }}')">Show individual iterations</span>
          <div class="iter-details" id="iter-{{ assistant }}-{{ task }}">
            {% for iter_result in r.repeat.iterations %}
            <p style="font-size:12px; margin: 8px 0 4px;"><strong>Iteration {{ loop.index }}</strong> â€” {% if iter_result.all_passed %}PASS{% else %}FAIL{% endif %}</p>
            <ul class="assertion-list" style="font-size:12px;">
              {% for a in iter_result.assertions %}
              <li{% if not a.passed %} class="failed"{% endif %}>{{ a.name }}{% if a.message %} â€” {{ a.message }}{% endif %}</li>
              {% endfor %}
            </ul>
            {% endfor %}
          </div>
          {% endif %}
          {% endif %}
          {% endfor %}
        </div>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<h2>Metrics Comparison</h2>
{% for metric_key in ["wall_clock_seconds", "cost_usd", "token_usage_input", "tool_calls_count", "assertion_pass_rate", "weighted_score"] %}
<div class="chart-section">
  <h3>{{ metric_key }}{% if repeat > 1 %} (avg){% endif %}</h3>
  {% for task in tasks %}
  <p style="font-size:12px; color:#666; margin: 4px 0;">{{ task }}</p>
  {% set max_val = [] %}
  {% for assistant in assistants %}
    {% set r = results[assistant][task] %}
    {% if r and r.metrics[metric_key] is not none %}
      {% if max_val.append(r.metrics[metric_key]) %}{% endif %}
    {% endif %}
  {% endfor %}
  {% set max_value = max_val|max if max_val else 1 %}
  {% for assistant in assistants %}
  {% set r = results[assistant][task] %}
  {% set val = r.metrics[metric_key] if r and r.metrics[metric_key] is not none else 0 %}
  {% set pct = (val / max_value * 100) if max_value > 0 else 0 %}
  <div class="chart-row">
    <span class="chart-label">{{ assistant }}</span>
    <div class="chart-bar" style="width: {{ pct }}%; max-width: 400px; background: var(--c{{ loop.index0 % 6 }});">&nbsp;</div>
    <span>{% if val %}{% if metric_key == "wall_clock_seconds" %}{{ "%.1f"|format(val) }}{% elif metric_key == "cost_usd" %}{{ "%.4f"|format(val) }}{% else %}{{ val }}{% endif %}{% else %}â€”{% endif %}{% if repeat > 1 and r and r.metrics_stats and r.metrics_stats[metric_key] and r.metrics_stats[metric_key].stddev is not none %} <span class="metric">Â± {% if metric_key == "wall_clock_seconds" %}{{ "%.1f"|format(r.metrics_stats[metric_key].stddev) }}{% elif metric_key == "cost_usd" %}{{ "%.4f"|format(r.metrics_stats[metric_key].stddev) }}{% else %}{{ r.metrics_stats[metric_key].stddev }}{% endif %}</span>{% endif %}</span>
  </div>
  {% endfor %}
  {% endfor %}
</div>
{% endfor %}

<script>
function toggleDetails(task) {
  var el = document.getElementById('details-' + task);
  if (el) el.classList.toggle('open');
}
function toggleIterDetails(id) {
  var el = document.getElementById('iter-' + id);
  if (el) el.classList.toggle('open');
}
</script>
</body>
</html>
