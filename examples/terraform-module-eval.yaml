# Terraform IBM Modules (TIM) Skill Evaluation
#
# Evaluates whether the terraform-ibm-modules-skills skill improves
# an assistant's ability to generate correct, idiomatic Terraform
# solutions using curated IBM-maintained modules (TIM).
#
# What the skill provides:
#   - Module discovery via MCP or Terraform Registry API
#   - Guidance to prefer TIM modules over raw provider resources
#   - Example-driven code generation from real module examples
#   - Validation workflow (terraform init/validate/plan)
#
# What this eval measures:
#   1. Correct file structure (main.tf, variables.tf, outputs.tf, etc.)
#   2. Use of TIM module sources (not raw ibm_ resources)
#   3. Proper HCL formatting and validation
#   4. Multi-module composition (VPC wired into VSI)
#   5. Documentation quality (README vs golden reference)
#   6. Variable/output design quality (vs golden reference)
#
# Requires: pip install agent-eval[similarity] for rouge/bleu/bertscore checks

assistants:
  # Baseline: no skill — relies on the model's training data alone
  claude-baseline:
    adapter: claude-code
    args:
      model: haiku

  # With TIM skill: should discover and use real TIM modules
  claude-with-tim-skill:
    adapter: claude-code
    args:
      model: haiku
    skills:
      - source: terraform-ibm-modules/terraform-ibm-modules-skills
        skill: terraform-ibm-modules-solution-builder

  # mistral vibe baseline for cross-assistant comparison
  vibe-baseline:
    adapter: mistral-vibe
    args:
      model: devstral-2

  vibe-with-tim-skill:
    adapter: mistral-vibe
    args:
      model: devstral-2
    skills:
        - source: terraform-ibm-modules/terraform-ibm-modules-skills
          skill: terraform-ibm-modules-solution-builder

tasks:
  - name: compose-vpc-and-vsi
    prompt: >
      Create a Terraform configuration that provisions an IBM Cloud
      VPC and deploys a Virtual Server Instance (VSI) into it.
    workdir: ./fixtures/vpc-vsi-ref
    timeout: 420
    assertions:
      # ── File structure ──────────────────────────────────────────
      - file_exists: "main.tf"
      - file_exists: "variables.tf"
      - file_exists: "outputs.tf"
      - file_exists: "versions.tf"
      - file_exists: "README.md"

      # ── TIM module usage (deterministic) ────────────────────────
      # Must reference the actual TIM module sources
      - file_contains: { path: "main.tf", pattern: "terraform-ibm-modules/landing-zone-vpc/ibm" }
      - file_contains: { path: "main.tf", pattern: "terraform-ibm-modules/landing-zone-vsi/ibm" }
      # Must use module blocks (not raw resources)
      - file_contains: { path: "main.tf", pattern: "module\\s+\"" }
      # Provider must be pinned
      - file_contains: { path: "versions.tf", pattern: "IBM-Cloud/ibm" }

      # ── Variable & output quality (deterministic) ───────────────
      - file_contains: { path: "variables.tf", pattern: "description\\s*=" }
      - file_contains: { path: "variables.tf", pattern: "type\\s*=" }
      - file_contains: { path: "outputs.tf", pattern: "value\\s*=" }

      # ── Code validation (deterministic) ─────────────────────────
      - command_succeeds: "terraform fmt -check"
      - command_succeeds: "terraform validate"

      # ── README quality (similarity) ─────────────────────────────
      # Does the README cover the same topics as the golden reference?
      - rouge: { actual: "README.md", expected: "./refs/expected-readme.md", metric: "rougeL", min_score: 0.35 }
      # Semantic meaning preserved even with different wording?
      - bertscore: { actual: "README.md", expected: "./refs/expected-readme.md", min_score: 0.75 }

      # ── Code structure (similarity) ─────────────────────────────
      # Are the right module blocks, arguments, and wiring present?
      - bleu: { actual: "main.tf", expected: "./refs/expected-main.tf", min_score: 0.25 }
      # Are the right variables defined with similar names/descriptions?
      - cosine_similarity: { actual: "variables.tf", expected: "./refs/expected-vars.tf", min_score: 0.7 }
